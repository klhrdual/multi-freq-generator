<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ToneGen Platinum</title>
    <meta name="description" content="白金風格多頻率音訊產生器">
    <style>
        :root {
            /* 白金/金屬風格配色 */
            --bg-body: #f0f2f5;
            --surface: #ffffff;
            --surface-metallic: linear-gradient(145deg, #ffffff, #e6e6e6);
            --primary: #7b8fa3; /* 藍灰色 */
            --primary-dark: #5a6e80;
            --accent: #00bcd4; /* 科技藍點綴 */
            --danger: #ff6b6b;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
            --shadow-soft: 6px 6px 12px #d1d9e6, -6px -6px 12px #ffffff;
            --shadow-inset: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            --radius-main: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 800px;
            box-sizing: border-box;
        }

        /* --- 視覺化圖表 --- */
        .visualizer-card {
            background: var(--surface);
            border-radius: var(--radius-main);
            padding: 4px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 140px;
            display: block;
            border-radius: 12px;
            background: #fcfcfc;
        }

        /* --- 控制列 (圖標按鈕) --- */
        .controls-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
            background: var(--surface);
            padding: 15px 20px;
            border-radius: var(--radius-main);
            box-shadow: var(--shadow-soft);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 金屬質感按鈕 */
        .btn-icon {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 12px;
            background: var(--surface-metallic);
            box-shadow: 3px 3px 6px #d1d9e6, -3px -3px 6px #ffffff;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .btn-icon:active {
            box-shadow: var(--shadow-inset);
            transform: scale(0.96);
        }

        .btn-icon.active-play {
            color: var(--accent);
            box-shadow: var(--shadow-inset);
        }
        
        .btn-icon.active-stop {
            color: var(--danger);
        }

        /* 總音量滑桿 */
        .master-vol-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 200px;
        }

        .vol-icon { width: 16px; height: 16px; opacity: 0.5; }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #e0e5ec;
            border-radius: 10px;
            box-shadow: inset 1px 1px 3px #cfd4db;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--surface);
            box-shadow: 2px 2px 4px #babecc, -2px -2px 4px #ffffff;
            margin-top: -6px;
            cursor: pointer;
        }

        /* --- 列表區 --- */
        .osc-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .osc-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr auto;
            gap: 15px;
            align-items: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.03);
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }
        
        /* 讓輸入框看起來乾淨 */
        .input-minimal {
            border: none;
            border-bottom: 2px solid #eee;
            background: transparent;
            font-size: 1rem;
            color: var(--text-main);
            padding: 5px 0;
            width: 100%;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .input-minimal:focus {
            outline: none;
            border-bottom-color: var(--accent);
        }

        select.input-minimal {
            cursor: pointer;
        }

        .btn-remove {
            background: transparent;
            border: none;
            color: #b0b0b0;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: color 0.2s;
        }
        .btn-remove:hover { color: var(--danger); background: #fff0f0; }

        /* --- 彈出視窗 (Modal) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(240, 242, 245, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: var(--surface);
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #fff;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }
        
        .modal-title { font-weight: 600; font-size: 1.1rem; color: var(--primary-dark); }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .control-group { margin-bottom: 20px; }
        .control-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 500;}
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* 預覽區域 (Staging) */
        .preview-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px;
            border: 1px dashed #ced6e0;
            margin-top: 10px;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-text {
            border: none;
            background: transparent;
            padding: 10px 20px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
        }
        
        .btn-primary {
            background: var(--surface-metallic);
            box-shadow: 3px 3px 6px #d1d9e6, -3px -3px 6px #ffffff;
            color: var(--primary-dark);
        }
        .btn-primary:active { box-shadow: var(--shadow-inset); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #333;
            color: #fff;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* RWD */
        @media (max-width: 600px) {
            .osc-card {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .osc-card .input-group:nth-child(3) { grid-column: 1 / -1; }
            .btn-remove { grid-column: 2; grid-row: 1; justify-self: end; }
            
            .controls-panel { flex-wrap: wrap; }
            .master-vol-container { order: 3; width: 100%; max-width: none; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="visualizer-card">
        <canvas id="visualizer"></canvas>
    </div>

    <div class="controls-panel">
        <div class="btn-group">
            <button id="playBtn" class="btn-icon" title="播放">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="stopBtn" class="btn-icon" title="停止" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
            </button>
            
            <button id="addBtn" class="btn-icon" title="新增頻率">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>

            <button id="sortBtn" class="btn-icon" title="按頻率排序">
                <svg viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/></svg>
            </button>
        </div>

        <div class="master-vol-container">
            <svg class="vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
            <input type="range" id="masterVolSlider" min="0" max="1" step="0.01" value="0.5">
        </div>

        <button id="shareBtn" class="btn-icon" title="分享連結">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
        </button>
    </div>

    <div id="oscList" class="osc-list"></div>
</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">配置新音源</div>
            <button class="btn-remove" onclick="closeModal()">✕</button>
        </div>
        
        <div class="modal-body">
            <div class="control-group">
                <label class="control-label">基礎頻率 (Fundamental)</label>
                <div class="row">
                    <select id="noteSelect" class="input-minimal col" onchange="syncFreqFromNote()">
                        <option value="">-- 自訂 Hz --</option>
                        <option value="261.63">C4 (261.6)</option>
                        <option value="293.66">D4 (293.6)</option>
                        <option value="329.63">E4 (329.6)</option>
                        <option value="349.23">F4 (349.2)</option>
                        <option value="392.00">G4 (392.0)</option>
                        <option value="440.00" selected>A4 (440.0)</option>
                        <option value="493.88">B4 (493.8)</option>
                        <option value="523.25">C5 (523.2)</option>
                    </select>
                    <input type="number" id="freqInput" class="input-minimal col" value="440" placeholder="Hz">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">音色/泛音生成 (單次行程)</label>
                <div class="row">
                    <select id="presetSelect" class="input-minimal col">
                        <option value="simple">單一頻率 (預設)</option>
                        <option value="octave">加八度音 (Fundamental + 2f)</option>
                        <option value="organ">管風琴感 (f, 2f, 4f)</option>
                        <option value="clarinet">類單簧管 (奇數泛音 f, 3f, 5f)</option>
                        <option value="bell">金屬鐘聲 (非整數泛音)</option>
                        <option value="chord_maj">大三和弦 (Major Triad)</option>
                    </select>
                    <select id="waveSelect" class="input-minimal col">
                        <option value="sine">正弦波 (Sine)</option>
                        <option value="triangle">三角波 (Tri)</option>
                        <option value="square">方波 (Square)</option>
                        <option value="sawtooth">鋸齒波 (Saw)</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 8px;">
                    <button class="btn-text" onclick="generateToStaging()" style="border:1px solid #ddd; padding:5px 10px; font-size:0.8rem;">↓ 生成至待送出區</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">待送出區 (確認後加入主控台)</label>
                <div id="stagingArea" class="preview-area">
                    <div style="text-align:center; color:#999; font-size:0.85rem; padding:10px;">尚未添加任何頻率</div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-text" onclick="closeModal()">取消</button>
            <button class="btn-text btn-primary" onclick="confirmAdd()">確認添加</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">訊息提示</div>

<script>
    // --- 全域變數 ---
    let audioCtx = null;
    let masterGain = null;
    let analyser = null;
    let oscillators = []; 
    let isPlaying = false;
    let animationId = null;

    // 資料狀態
    let settings = [
        { id: '1', freq: 440, type: 'sine', vol: 0.5 }
    ];
    let masterVolume = 0.5;

    // Staging Area (Modal)
    let stagingList = [];

    // DOM 元素
    const oscListEl = document.getElementById('oscList');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const addBtn = document.getElementById('addBtn');
    const sortBtn = document.getElementById('sortBtn');
    const shareBtn = document.getElementById('shareBtn');
    const masterVolSlider = document.getElementById('masterVolSlider');
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');
    const toastEl = document.getElementById('toast');
    
    // Modal DOM
    const modalOverlay = document.getElementById('modalOverlay');
    const stagingArea = document.getElementById('stagingArea');
    const freqInput = document.getElementById('freqInput');
    const noteSelect = document.getElementById('noteSelect');
    const presetSelect = document.getElementById('presetSelect');
    const waveSelect = document.getElementById('waveSelect');

    // --- 初始化 ---
    function init() {
        loadFromUrl();
        renderList();
        setupCanvas();
        updatePlayStateUI();

        window.addEventListener('popstate', () => {
            loadFromUrl();
            renderList();
            if(isPlaying) restartAudioEngine();
        });
    }

    // --- Audio Engine ---
    function initAudioContext() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = masterVolume;
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);
        }
    }

    function startAudio() {
        initAudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        stopAudioEngine(false);

        const now = audioCtx.currentTime;
        settings.forEach(data => createOscillatorNode(data, now));

        masterGain.gain.cancelScheduledValues(now);
        masterGain.gain.setValueAtTime(0, now);
        masterGain.gain.linearRampToValueAtTime(masterVolume, now + 0.1);

        isPlaying = true;
        updatePlayStateUI();
        drawVisualizer();
    }

    function createOscillatorNode(data, startTime) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = data.type;
        osc.frequency.value = data.freq;
        gain.gain.value = data.vol;

        osc.connect(gain);
        gain.connect(masterGain);
        osc.start(startTime);

        oscillators.push({ id: data.id, oscNode: osc, gainNode: gain });
    }

    function stopAudio() {
        if (!audioCtx || !isPlaying) return;
        const now = audioCtx.currentTime;
        masterGain.gain.cancelScheduledValues(now);
        masterGain.gain.setValueAtTime(masterGain.gain.value, now);
        masterGain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

        setTimeout(() => stopAudioEngine(true), 150);
    }

    function stopAudioEngine(resetState) {
        oscillators.forEach(o => {
            try { o.oscNode.stop(); o.oscNode.disconnect(); o.gainNode.disconnect(); } catch(e){}
        });
        oscillators = [];
        if (animationId) cancelAnimationFrame(animationId);
        
        // 清除 Canvas (保持背景)
        canvasCtx.fillStyle = '#fcfcfc';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

        if (resetState) {
            isPlaying = false;
            updatePlayStateUI();
        }
    }

    function restartAudioEngine() {
        if(isPlaying) {
            stopAudioEngine(false);
            startAudio();
        }
    }

    function updateAudioParam(id, key, value) {
        if (!isPlaying || !audioCtx) return;
        const target = oscillators.find(o => o.id === id);
        if (target) {
            const now = audioCtx.currentTime;
            if (key === 'freq') target.oscNode.frequency.setTargetAtTime(value, now, 0.05);
            else if (key === 'vol') target.gainNode.gain.setTargetAtTime(value, now, 0.05);
            else if (key === 'type') target.oscNode.type = value;
        }
    }

    // --- UI Logic ---

    function renderList() {
        oscListEl.innerHTML = '';
        settings.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'osc-card';
            card.dataset.id = item.id;
            
            card.innerHTML = `
                <div class="input-group">
                    <input type="number" class="input-minimal" value="${item.freq}" 
                           oninput="handleInput('${item.id}', 'freq', this.value)" placeholder="Hz">
                </div>
                <div class="input-group">
                    <select class="input-minimal" onchange="handleInput('${item.id}', 'type', this.value)">
                        <option value="sine" ${item.type === 'sine' ? 'selected' : ''}>Sine</option>
                        <option value="square" ${item.type === 'square' ? 'selected' : ''}>Square</option>
                        <option value="sawtooth" ${item.type === 'sawtooth' ? 'selected' : ''}>Saw</option>
                        <option value="triangle" ${item.type === 'triangle' ? 'selected' : ''}>Tri</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="range" min="0" max="1" step="0.01" value="${item.vol}" 
                           oninput="handleInput('${item.id}', 'vol', this.value)" title="Volume">
                </div>
                <button class="btn-remove" onclick="removeItem('${item.id}')" title="移除">✕</button>
            `;
            oscListEl.appendChild(card);
        });
    }

    window.handleInput = function(id, key, value) {
        const item = settings.find(s => s.id === id);
        if (!item) return;
        if (key === 'freq') item.freq = parseFloat(value);
        else if (key === 'vol') item.vol = parseFloat(value);
        else item.type = value;
        updateAudioParam(id, key, key === 'type' ? value : parseFloat(value));
        updateUrlHash();
    };

    window.removeItem = function(id) {
        settings = settings.filter(s => s.id !== id);
        renderList();
        if(isPlaying) {
            const idx = oscillators.findIndex(o => o.id === id);
            if(idx > -1) {
                const target = oscillators[idx];
                target.gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);
                setTimeout(() => { try{target.oscNode.stop();}catch(e){} }, 100);
                oscillators.splice(idx, 1);
            }
        }
        updateUrlHash();
    };

    // --- 排序功能 (One-off) ---
    sortBtn.addEventListener('click', () => {
        settings.sort((a, b) => a.freq - b.freq);
        renderList();
        restartAudioEngine(); // 重啟以匹配順序 (雖非必要，但較保險)
        showToast("已依頻率排序");
    });

    // --- Modal Logic ---
    addBtn.addEventListener('click', () => {
        modalOverlay.classList.add('open');
        stagingList = []; // 清空待送出區
        renderStagingArea();
        // 預設生成一個 fundamental 到 staging
        generateToStaging();
    });

    window.closeModal = function() {
        modalOverlay.classList.remove('open');
    };

    window.syncFreqFromNote = function() {
        const val = noteSelect.value;
        if(val) freqInput.value = val;
    };

    window.generateToStaging = function() {
        const baseFreq = parseFloat(freqInput.value) || 440;
        const wave = waveSelect.value;
        const preset = presetSelect.value;

        let newItems = [];
        const baseId = Date.now(); // temp id prefix

        // 樂器邏輯
        if (preset === 'simple') {
            newItems.push({ freq: baseFreq, type: wave, vol: 0.5 });
        } else if (preset === 'octave') {
            newItems.push({ freq: baseFreq, type: wave, vol: 0.6 });
            newItems.push({ freq: baseFreq * 2, type: wave, vol: 0.3 });
        } else if (preset === 'organ') {
            newItems.push({ freq: baseFreq, type: wave, vol: 0.6 });
            newItems.push({ freq: baseFreq * 2, type: wave, vol: 0.3 });
            newItems.push({ freq: baseFreq * 4, type: wave, vol: 0.1 });
        } else if (preset === 'clarinet') {
            newItems.push({ freq: baseFreq, type: 'square', vol: 0.6 }); // 單簧管常用方波或奇數泛音
            newItems.push({ freq: baseFreq * 3, type: 'square', vol: 0.3 });
            newItems.push({ freq: baseFreq * 5, type: 'square', vol: 0.1 });
        } else if (preset === 'bell') {
            newItems.push({ freq: baseFreq, type: 'sine', vol: 0.6 });
            newItems.push({ freq: baseFreq * 2.03, type: 'sine', vol: 0.2 });
            newItems.push({ freq: baseFreq * 4.1, type: 'sine', vol: 0.1 });
        } else if (preset === 'chord_maj') {
            newItems.push({ freq: baseFreq, type: wave, vol: 0.4 }); // Root
            newItems.push({ freq: baseFreq * 1.2599, type: wave, vol: 0.3 }); // Major 3rd (approx)
            newItems.push({ freq: baseFreq * 1.4983, type: wave, vol: 0.3 }); // Perfect 5th (approx)
        }

        // 添加到 Staging 並賦予隨機 ID
        newItems.forEach(item => {
            stagingList.push({
                ...item,
                id: Math.random().toString(36).substr(2, 9)
            });
        });

        renderStagingArea();
    };

    function renderStagingArea() {
        stagingArea.innerHTML = '';
        if (stagingList.length === 0) {
            stagingArea.innerHTML = `<div style="text-align:center; color:#999; font-size:0.85rem; padding:10px;">尚未添加任何頻率</div>`;
            return;
        }

        stagingList.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                <span>${Math.round(item.freq)}Hz (${item.type})</span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:0.8em; color:#888;">Vol: ${(item.vol*100).toFixed(0)}%</span>
                    <button class="btn-remove" style="padding:2px;" onclick="removeFromStaging(${index})">✕</button>
                </div>
            `;
            stagingArea.appendChild(div);
        });
    }

    window.removeFromStaging = function(index) {
        stagingList.splice(index, 1);
        renderStagingArea();
    };

    window.confirmAdd = function() {
        if (stagingList.length === 0) {
            closeModal();
            return;
        }
        
        // 將 staging 內容加入主 settings
        stagingList.forEach(item => {
            settings.push(item);
            if (isPlaying) {
                createOscillatorNode(item, audioCtx.currentTime);
            }
        });

        renderList();
        updateUrlHash();
        closeModal();
        showToast(`已添加 ${stagingList.length} 個音頻`);
    };

    // --- Master Volume ---
    masterVolSlider.addEventListener('input', (e) => {
        masterVolume = parseFloat(e.target.value);
        if (masterGain) masterGain.gain.setTargetAtTime(masterVolume, audioCtx.currentTime, 0.05);
    });

    // --- Play State UI ---
    function updatePlayStateUI() {
        if (isPlaying) {
            playBtn.style.display = 'none';
            stopBtn.style.display = 'flex';
            document.querySelector('#playBtn').classList.add('active-play');
        } else {
            playBtn.style.display = 'flex';
            stopBtn.style.display = 'none';
            document.querySelector('#playBtn').classList.remove('active-play');
        }
    }

    playBtn.addEventListener('click', startAudio);
    stopBtn.addEventListener('click', stopAudio);

    shareBtn.addEventListener('click', () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => showToast("連結已複製"));
    });

    function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 3000);
    }

    // --- Canvas Visualizer ---
    function setupCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvasCtx.scale(dpr, dpr);
    }
    window.addEventListener('resize', setupCanvas);

    function drawVisualizer() {
        if (!isPlaying) return;
        animationId = requestAnimationFrame(drawVisualizer);
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteTimeDomainData(dataArray);

        // 白金風格背景與線條
        canvasCtx.fillStyle = '#ffffff'; 
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = '#00bcd4'; // Accent color line
        canvasCtx.beginPath();

        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const sliceWidth = width * 1.0 / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * height / 2;
            if (i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);
            x += sliceWidth;
        }
        canvasCtx.stroke();
    }

    // --- URL Handling ---
    function updateUrlHash() {
        const simpleData = settings.map(s => ({ f: s.freq, t: s.type, v: s.vol }));
        const b64 = btoa(JSON.stringify(simpleData));
        history.replaceState(null, null, '#config=' + b64);
    }

    function loadFromUrl() {
        const hash = window.location.hash;
        if (hash && hash.startsWith('#config=')) {
            try {
                const b64 = hash.substring(8);
                const simpleData = JSON.parse(atob(b64));
                settings = simpleData.map(s => ({
                    id: Math.random().toString(36).substr(2, 9),
                    freq: s.f, type: s.t, vol: s.v
                }));
            } catch (e) {
                console.error(e);
            }
        }
    }

    init();
</script>
</body>
</html>
